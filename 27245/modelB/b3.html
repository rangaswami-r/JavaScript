<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Enhanced Tic-Tac-Toe</title>
<style>
  #game-container {
    width: 100%;
    text-align: center;
  }
  #board {
    display: grid;
    grid-template-columns: repeat(3, 100px);
    grid-gap: 5px;
    width: 315px;
    margin: 20px auto;
  }
  .cell {
    width: 100px;
    height: 100px;
    background: #eee;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2em;
    cursor: pointer;
  }
  .cell:hover {
    background: #ddd;
  }
  .cell.disabled {
    background: #ccc;
    cursor: not-allowed;
  }
  .winner {
    background: #aaffaa;
  }
  #status, #history {
    font-size: 1.2em;
    margin-bottom: 10px;
  }
  #history > div {
    margin-bottom: 5px;
  }
  #board-size, #player-names {
    margin-top: 20px;
  }
  #board-size > button, #player-names > button {
    margin: 5px;
  }
  .power-up {
    font-size: 1em;
    margin: 5px;
    cursor: pointer;
  }
  .power-up.disabled {
    color: #aaa;
    cursor: default;
  }
</style>
</head>
<body>

<div id="game-container">
  <div id="player-names">
    <input type="text" id="player-x" placeholder="Player X's name">
    <input type="text" id="player-o" placeholder="Player O's name">
    <button onclick="setPlayerNames()">Start Game</button>
  </div>
  <div id="status">Enter player names to start the game.</div>
  <div id="board-size">
    <button onclick="initGame(3)">3x3</button>
    <button onclick="initGame(4)">4x4</button>
    <button onclick="initGame(5)">5x5</button>
  </div>
  <div id="board"></div>
  <div id="power-ups">
    <span class="power-up" onclick="undoMove()">Undo Move</span>
    <span class="power-up" onclick="swapTurns()">Swap Turns</span>
  </div>
  <div id="history">
    <div>Player X's last move: <span id="x-last-move">-</span></div>
    <div>Player O's last move: <span id="o-last-move">-</span></div>
  </div>
</div>

<script>
  let boardSize;
  let currentPlayer = 'X';
  let moves = { 'X': [], 'O': [] };
  let history = { 'X': [], 'O': [] };
  let winPatterns;
  let cells;
  let playerNames = { 'X': 'Player X', 'O': 'Player O' };
  let powerUps = { 'X': 1, 'O': 1 };
  let canUsePowerUp = true;

  function setPlayerNames() {
    playerNames.X = document.getElementById('player-x').value || 'Player X';
    playerNames.O = document.getElementById('player-o').value || 'Player O';
    document.getElementById('player-names').style.display = 'none';
    document.getElementById('status').textContent = 'Select board size to start the game.';
  }

  function initGame(size) {
    boardSize = size;
    const board = document.getElementById('board');
    board.style.gridTemplateColumns = `repeat(${size}, 100px)`;
    board.innerHTML = '';
    for (let i = 0; i < size * size; i++) {
      const cell = document.createElement('div');
      cell.className = 'cell';
      cell.dataset.index = i;
      board.appendChild(cell);
    }
    cells = document.querySelectorAll('.cell');
    winPatterns = generateWinPatterns(size);
    cells.forEach((cell, index) => {
      cell.onclick = () => makeMove(cell, index);
    });
    updateStatus();
  }

  function generateWinPatterns(size) {
    const patterns = [];
    for (let i = 0; i < size; i++) {
      const row = Array.from({length: size}, (_, j) => i * size + j);
      const col = Array.from({length: size}, (_, j) => j * size + i);
      patterns.push(row, col);
    }
    const diagonal1 = Array.from({length: size}, (_, i) => i * size + i);
    const diagonal2 = Array.from({length: size}, (_, i) => (size - 1 - i) * size + i);
    patterns.push(diagonal1, diagonal2);
    return patterns;
  }

  function makeMove(cell, index) {
    if (!cell.textContent && !cell.classList.contains('disabled') && canUsePowerUp) {
      cell.textContent = currentPlayer;
      moves[currentPlayer].push(index);
      history[currentPlayer].push(index);
      updateLastMoveDisplay(currentPlayer, index + 1);

      const winner = checkWinner([...cells].map(c => c.textContent));
      if (winner) {
        announceWinner(winner);
        return;
      }
      if (moves.X.length + moves.O.length === boardSize * boardSize) {
        announceDraw();
        return;
      }

      if (moves[currentPlayer].length > boardSize - 1) {
        const oldestMove = moves[currentPlayer].shift();
        cells[oldestMove].textContent = '';
      }

      currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
      updateStatus();
      updatePowerUps();
    }
  }

  function undoMove() {
    if (canUsePowerUp && history[currentPlayer].length > 0) {
      const lastMoveIndex = history[currentPlayer].pop();
      cells[lastMoveIndex].textContent = '';
      moves[currentPlayer].pop();
      currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
      updateStatus();
      updatePowerUps();
    }
  }

  function swapTurns() {
    if (canUsePowerUp) {
      currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
      updateStatus();
      updatePowerUps();
    }
  }

  function updateStatus() {
    document.getElementById('status').textContent = `${playerNames[currentPlayer]}'s Turn`;
  }

  function updateLastMoveDisplay(player, move) {
    document.getElementById(`${player.toLowerCase()}-last-move`).textContent = move;
  }

  function updatePowerUps() {
    const powerUpElements = document.querySelectorAll('.power-up');
    powerUpElements.forEach((powerUp, index) => {
      if (index < powerUps[currentPlayer]) {
        powerUp.classList.remove('disabled');
      } else {
        powerUp.classList.add('disabled');
      }
    });
    canUsePowerUp = powerUps[currentPlayer] > 0;
  }

  function checkWinner(board) {
    for (let pattern of winPatterns) {
      const firstSymbol = board[pattern[0]];
      if (firstSymbol && pattern.every(index => board[index] === firstSymbol)) {
        return firstSymbol;
      }
    }
    return null;
  }

  function announceWinner(winner) {
    document.getElementById('status').textContent = `${playerNames[winner]} wins!`;
    disableAllCells();
  }

  function announceDraw() {
    document.getElementById('status').textContent = 'Game ends in a draw!';
  }

  function disableAllCells() {
    cells.forEach(cell => {
      cell.classList.add('disabled');
      cell.onclick = null;
    });
  }
</script>

</body>
</html>
